{"version":3,"sources":["re_frisk/trace.cljs"],"mappings":"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","names":["re-frisk.trace/normalize-traces","traces","cljs.core.reduce","p__59191","map__59193","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply","cljs.core/hash-map","cljs.core.get","items","op-type","tags","duration","id","trace","cljs.core._EQ_","cljs.core/namespace","item","G__59198","cljs.core/Keyword","cljs.core.conj","cljs.core.merge","cljs.core.dissoc","cljs.core.assoc","cljs.core/select-keys","re-frisk.utils/truncate-name","cljs.core/first","re-frisk.diff.diff/diff","prev","cljs.core/peek","cljs.core/pop","re-frisk.utils/str-ms","cljs.core.update","cljs.core/conj","re-frame.interop/reagent-id","re-frame.db/app-db","cljs.core.sort_by","re-frisk.trace/normalize-durations","first-event","p__59220","map__59221","subs?","subs","handler-duration","fx-duration","map__59251","start","created-duration-cached","run-duration","created-duration","disposed-duration","render-duration","p__59252","map__59253","acc","end","cached?","G__59257","cljs.core/+","cljs.core/inc","cljs.core/not","handler-fx-duration","G__59268"],"sourcesContent":["(ns re-frisk.trace\n  (:require [re-frisk.diff.diff :as diff]\n            [re-frisk.utils :as utils]\n            [re-frame.trace]\n            [re-frame.interop :as interop]\n            [re-frame.db :as db]))\n\n(defn normalize-traces [traces]\n  (reduce (fn [items {:keys [op-type tags duration id] :as trace}]\n            (let [op-type (if (= (namespace op-type) \"sub\") :sub op-type)\n                  item    {:indx id :trace? true}]\n              (case op-type\n                ;:re-frame.router/fsm-trigger\n                #_(conj items (merge item\n                                     (select-keys trace [:id :op-type :operation :start :end])))\n                :event\n                (conj items (merge (dissoc item :trace?)\n                                   (assoc (select-keys trace [:id :op-type :operation :duration\n                                                              :start :end])\n                                     :event (:event tags)\n                                     :truncated-name (utils/truncate-name (str (first (:event tags))))\n                                     :app-db-diff (diff/diff (:app-db-before tags) (:app-db-after tags)))))\n                :event/handler\n                (let [prev (peek items)]\n                  (if (= (:op-type prev :event))\n                    (conj (pop items) (assoc prev :handler-duration duration))\n                    (conj items (merge item\n                                       (select-keys trace [:id :op-type :operation :duration])))))\n                :event/do-fx\n                (let [prev (peek items)]\n                  (if (= (:op-type prev :event))\n                    (conj (pop items) (assoc prev :fx-duration duration))\n                    (conj items (merge item\n                                       (select-keys trace [:id :op-type :duration])))))\n                (:sub :render)\n                (let [prev  (peek items)\n                      trace (select-keys trace [:id :op-type :operation :duration :start :end])\n                      trace (assoc trace :duration-ms (utils/str-ms (:duration trace))\n                                         :reaction (:reaction tags)\n                                         :cached? (:cached? tags)\n                                         :input-signals (:input-signals tags))]\n                  (if (:subs? prev)\n                    (conj (pop items) (update prev :subs conj trace))\n                    (conj items (merge item\n                                       {:op-type         :subs :subs? true :subs [trace]\n                                        :app-db-reaction (interop/reagent-id db/app-db)\n                                        :start           (:start trace)}))))\n                items)))\n          []\n          (sort-by :id traces)))\n\n(defn normalize-durations [first-event]\n  (fn [{:keys [subs? subs op-type handler-duration fx-duration]\n        :as   trace}]\n    (let [{:keys [duration handler-duration fx-duration start created-duration-cached\n                  run-duration created-duration disposed-duration render-duration]\n           :as   trace}\n          (cond\n            subs?\n            (merge trace\n                   (reduce (fn [acc {:keys [duration op-type end cached?]}]\n                             (cond-> (update acc :duration + duration)\n                                     :always\n                                     (assoc :end end)\n                                     (= op-type :sub/run)\n                                     (-> (update :run-count inc)\n                                         (update :run-duration + duration))\n                                     (and (= op-type :sub/create) (not cached?))\n                                     (-> (update :created-count inc)\n                                         (update :created-duration + duration))\n                                     (and (= op-type :sub/create) cached?)\n                                     (-> (update :created-count-cached inc)\n                                         (update :created-duration-cached + duration))\n                                     (= op-type :sub/dispose)\n                                     (-> (update :disposed-count inc)\n                                         (update :disposed-duration + duration))\n                                     (= op-type :render)\n                                     (-> (update :render-count inc)\n                                         (update :render-duration + duration))))\n                           {:duration                0\n                            :run-count               0\n                            :run-duration            0\n                            :render-count            0\n                            :render-duration         0\n                            :created-count           0\n                            :created-duration        0\n                            :disposed-count          0\n                            :disposed-duration       0\n                            :created-count-cached    0\n                            :created-duration-cached 0}\n                           subs))\n            (= op-type :event)\n            (let [handler-fx-duration (+ handler-duration fx-duration)]\n              (assoc trace :handler-fx-duration handler-fx-duration\n                           :handler-fx-duration-ms (utils/str-ms handler-fx-duration)))\n            :else\n            trace)]\n      (cond-> trace\n              duration\n              (assoc :duration-ms (utils/str-ms duration))\n              handler-duration\n              (assoc :handler-duration-ms (utils/str-ms handler-duration))\n              fx-duration\n              (assoc :fx-duration-ms (utils/str-ms fx-duration))\n              run-duration\n              (assoc :run-duration-ms (utils/str-ms run-duration))\n              created-duration\n              (assoc :created-duration-ms (utils/str-ms created-duration))\n              created-duration-cached\n              (assoc :created-duration-cached-ms (utils/str-ms created-duration-cached))\n              disposed-duration\n              (assoc :disposed-duration-ms (utils/str-ms disposed-duration))\n              render-duration\n              (assoc :render-duration-ms (utils/str-ms render-duration))\n              :always\n              (assoc :position (- start (:start first-event)))))))"]}